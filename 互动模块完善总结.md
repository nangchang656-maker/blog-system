# 互动模块完善总结

## 已完成的任务

### 1. 数据库索引问题修复 ✅

**问题描述：**
- 原有的唯一索引 `uk_user_target` 和 `uk_user_article` 不包含 `deleted` 字段
- 使用逻辑删除时，用户取消点赞/收藏后再次操作会报唯一键冲突错误

**解决方案：**
- 创建了 SQL 脚本：`sql/fix_interaction_indexes.sql`
- 删除原有唯一索引，创建包含 `deleted` 字段的新唯一索引
- 同时修复了 `like_record`、`collect` 和 `follow` 三张表

**SQL 脚本内容：**
```sql
-- 修复 like_record 表
ALTER TABLE `like_record` DROP INDEX `uk_user_target`;
ALTER TABLE `like_record` ADD UNIQUE INDEX `uk_user_target_deleted`(`user_id`, `target_id`, `type`, `deleted`);

-- 修复 collect 表
ALTER TABLE `collect` DROP INDEX `uk_user_article`;
ALTER TABLE `collect` ADD UNIQUE INDEX `uk_user_article_deleted`(`user_id`, `article_id`, `deleted`);

-- 修复 follow 表
ALTER TABLE `follow` DROP INDEX `uk_user_follow`;
ALTER TABLE `follow` ADD UNIQUE INDEX `uk_user_follow_deleted`(`user_id`, `follow_user_id`, `deleted`);
```

### 2. 点赞/收藏逻辑优化 ✅ （重要优化）

**优化思路：恢复已删除记录，而不是物理删除或重复插入**

#### 2.1 Mapper 层增强

**LikeRecordMapper.java 新增方法：**
```java
// 查询点赞记录（包括已逻辑删除的，不受@TableLogic影响）
@Select("SELECT * FROM like_record WHERE user_id = #{userId} AND target_id = #{targetId} AND type = #{type} LIMIT 1")
LikeRecord selectIncludeDeleted(@Param("userId") Long userId,
                                 @Param("targetId") Long targetId,
                                 @Param("type") Integer type);

// 恢复已逻辑删除的点赞记录（将deleted改为0，并更新create_time）
@Update("UPDATE like_record SET deleted = 0, create_time = NOW() WHERE user_id = #{userId} AND target_id = #{targetId} AND type = #{type} AND deleted = 1")
int restoreDeleted(@Param("userId") Long userId,
                   @Param("targetId") Long targetId,
                   @Param("type") Integer type);
```

**CollectMapper.java 新增方法：**
```java
// 查询收藏记录（包括已逻辑删除的）
@Select("SELECT * FROM collect WHERE user_id = #{userId} AND article_id = #{articleId} LIMIT 1")
Collect selectIncludeDeleted(@Param("userId") Long userId,
                              @Param("articleId") Long articleId);

// 恢复已逻辑删除的收藏记录
@Update("UPDATE collect SET deleted = 0, create_time = NOW() WHERE user_id = #{userId} AND article_id = #{articleId} AND deleted = 1")
int restoreDeleted(@Param("userId") Long userId,
                   @Param("articleId") Long articleId);
```

#### 2.2 Service 层逻辑重构

**点赞流程（likeArticle）：**
1. 验证文章是否存在
2. 查询是否存在点赞记录（包括已逻辑删除的）
   - 如果记录存在且未删除 → 提示"已经点赞过"
   - 如果记录存在但已删除 → **恢复该记录**（将deleted改为0）
   - 如果记录不存在 → 插入新记录
3. 增加文章点赞数

**取消点赞流程（unlikeArticle）：**
1. 查询点赞记录（只查未删除的）
2. 逻辑删除该记录（将deleted改为1）
3. 减少文章点赞数

收藏功能（collectArticle/uncollectArticle）的实现逻辑完全相同。

**优化效果对比：**
```
优化前：
  点赞 → 取消 → 再次点赞
  数据库：id=1(deleted=1), id=2(新插入，唯一索引冲突❌)

优化后：
  点赞 → 取消 → 再次点赞
  数据库：id=1(deleted=0，恢复记录✅)
```

**优点：**
- ✅ 保留完整的操作历史记录
- ✅ 避免主键ID不断增长
- ✅ 数据库更加整洁（每个用户对每篇文章只有一条记录）
- ✅ 支持数据分析（可以统计用户反复点赞/取消的行为）

详细优化说明请查看：`互动模块优化说明.md`

#### 2.1 InteractionService 增强
- 添加 `isLiked()` 方法：检查用户是否已点赞
- 添加 `isCollected()` 方法：检查用户是否已收藏
- 添加 `getCollectedArticles()` 方法：获取用户收藏列表（分页）

#### 2.2 ArticleDetailVO 完善
- 添加 `collectCount` 字段，显示文章被收藏的总数
- `ArticleServiceImpl.getArticleDetail()` 方法已正确填充该字段

#### 2.3 UserInfoVO 统计数据
新增统计字段：
- `articleCount`：用户发布的文章数（仅已发布）
- `likeCount`：用户所有文章获得的点赞总数
- `collectCount`：用户收藏的文章数量
- `followCount`：用户关注的人数
- `fansCount`：用户的粉丝数

#### 2.4 创建 FollowMapper
- 创建文件：`blog-application/src/main/java/cn/lzx/blog/mapper/FollowMapper.java`
- 用于支持关注功能的数据访问

#### 2.5 新增 API 接口
- `GET /api/article/my-collections`：获取当前用户的收藏列表（分页）
- 支持 `page` 和 `size` 参数

### 3. 前端功能实现 ✅

#### 3.1 文章详情页增强
- 显示文章收藏数 (`collectCount`)
- 点击收藏/取消收藏时，前端实时更新收藏数

**修改文件：**
- `blog-frontend/Blog/src/views/article/ArticleDetailView.vue`
- `blog-frontend/Blog/src/api/article.ts`（添加 `collectCount` 到 `ArticleDetail` 接口）

#### 3.2 个人中心页面完善

**统计数据展示：**
- 文章数、获赞数、收藏数、关注数、粉丝数
- 数据来自后端 `UserInfoVO`，自动计算展示

**收藏列表功能：**
- 点击"收藏"标签页时懒加载收藏列表
- 支持分页浏览
- 显示文章封面、标题、摘要、作者、浏览量、点赞数
- 点击文章跳转到详情页
- 响应式布局，鼠标悬停效果

**修改文件：**
- `blog-frontend/Blog/src/views/user/ProfileView.vue`
- `blog-frontend/Blog/src/api/article.ts`（添加 `getMyCollections` API）

## 项目目录结构

### 后端新增文件
```
blog-application/
├── src/main/java/cn/lzx/blog/
│   └── mapper/
│       └── FollowMapper.java  (新建)
└── sql/
    └── fix_interaction_indexes.sql  (新建)
```

### 后端修改文件
```
blog-application/
├── src/main/java/cn/lzx/blog/
│   ├── controller/api/
│   │   └── ArticleController.java  (新增收藏列表接口)
│   ├── service/
│   │   ├── InteractionService.java  (新增3个方法)
│   │   └── impl/
│   │       ├── InteractionServiceImpl.java  (实现新方法)
│   │       └── UserServiceImpl.java  (添加统计计算)
│   └── vo/
│       ├── ArticleDetailVO.java  (添加 collectCount)
│       └── UserInfoVO.java  (添加5个统计字段)
```

### 前端修改文件
```
blog-frontend/Blog/src/
├── api/
│   └── article.ts  (添加 collectCount、getMyCollections)
└── views/
    ├── article/
    │   └── ArticleDetailView.vue  (显示收藏数)
    └── user/
        └── ProfileView.vue  (完整实现收藏列表)
```

## 数据库迁移步骤

执行以下 SQL 脚本修复索引问题：
```bash
mysql -u [用户名] -p [数据库名] < sql/fix_interaction_indexes.sql
```

## 功能测试清单

### 点赞功能测试
- [ ] 点赞文章成功
- [ ] 取消点赞成功
- [ ] 取消点赞后再次点赞（验证索引修复）
- [ ] 文章详情页显示正确的点赞状态和数量

### 收藏功能测试
- [ ] 收藏文章成功
- [ ] 取消收藏成功
- [ ] 取消收藏后再次收藏（验证索引修复）
- [ ] 文章详情页显示正确的收藏状态和数量
- [ ] 个人中心收藏列表正确显示
- [ ] 收藏列表分页功能正常

### 用户统计数据测试
- [ ] 文章数统计正确
- [ ] 获赞数统计正确
- [ ] 收藏数统计正确
- [ ] 关注数统计正确（预留）
- [ ] 粉丝数统计正确（预留）

## 下一步工作建议

1. **评论功能开发**
   - 实现一级评论和楼中楼回复
   - 评论点赞功能
   - 评论管理（编辑、删除）

2. **关注功能完善**
   - 关注/取消关注用户
   - 关注列表展示
   - 粉丝列表展示

3. **浏览历史功能**
   - 记录用户浏览的文章
   - 个人中心显示浏览历史
   - 支持清除历史记录

4. **性能优化**
   - 使用 Redis 缓存热门文章的点赞/收藏数
   - 使用消息队列异步处理统计数据更新
   - 添加限流防止刷点赞/收藏

## 技术要点

### 逻辑删除与唯一索引
- MyBatis-Plus 的 `@TableLogic` 注解只影响 SQL 查询
- 唯一索引需要手动添加 `deleted` 字段
- 推荐方案：`UNIQUE KEY (user_id, target_id, type, deleted)`

### 统计数据计算
- 实时计算 vs 冗余存储：当前采用实时计算
- 优化方案：大量用户时可考虑定时任务更新统计表

### 前端性能优化
- 收藏列表采用懒加载（点击标签页时才加载）
- 支持分页，避免一次加载过多数据
- 使用 `v-loading` 提供加载反馈

## 遇到的问题与解决

1. **问题：**FollowMapper 不存在导致编译错误
   - **解决：**创建 `FollowMapper.java` 文件

2. **问题：**ArticleController 返回类型 `R<Page>` 报错
   - **解决：**R 类不支持泛型，改为 `R` 类型

3. **问题：**前端 TypeScript 类型错误
   - **解决：**在 `ArticleDetail` 接口添加 `collectCount: number`

4. **问题：**收藏列表文章顺序不符合预期
   - **解决：**按收藏时间倒序排列（最新收藏的在前）
